package com.example.serialcommdemo.util;

import com.example.serialcommdemo.exception.SerialPortException;
import lombok.extern.slf4j.Slf4j;

import java.io.IOException;
import java.nio.ByteBuffer;
import java.nio.channels.ReadableByteChannel;
import java.nio.channels.WritableByteChannel;
import java.nio.charset.Charset;

/**
 * @author Wei Zhanwei
 * @since 2023/2/24 11:54
 **/
@Slf4j
public class NioUtil {
    public static String read(ReadableByteChannel channel, Charset charset) throws IOException {
        ByteBuffer byteBuffer = ByteBuffer.allocate(1024);
        byte[] bytes = new byte[0];
        while (channel.read(byteBuffer) > 0) {
            byte[] array = ArrayUtil.slice(byteBuffer.array(), 0, byteBuffer.position());
            bytes = ArrayUtil.concat(bytes, array);
            byteBuffer.flip();
            byteBuffer.clear();
        }
        return new String(bytes, charset);
    }

    public static void write(WritableByteChannel channel, String msg, Charset charset) {
        ByteBuffer byteBuffer = ByteBuffer.wrap(msg.getBytes(charset));
        try {
            int write = channel.write(byteBuffer);
            System.out.println(write);
        } catch (IOException e) {
            throw new SerialPortException(e);
        }
        byteBuffer.flip();
        byteBuffer.clear();
    }
}
